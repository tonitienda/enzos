name: CI

on:
  pull_request:

permissions:
  contents: read
  packages: write

jobs:
  build-build-env:
    name: Build build-env image (only when Dockerfile.build-env changes)
    runs-on: ubuntu-latest
    outputs:
      image: ${{ steps.build-image.outputs.image }}
      tag: ${{ steps.build-image.outputs.tag }}
      built: ${{ steps.build-image.outputs.built }}
      pushable: ${{ steps.build-image.outputs.pushable }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build build-env image
        id: build-image
        uses: ./.github/actions/docker-image
        with:
          dockerfile: Dockerfile.build-env
          image-name: enzos-build
          build-args: --build-arg MAKE_JOBS=1
          token: ${{ secrets.GITHUB_TOKEN }}

  build-run-env:
    name: Build run-env image (only when Dockerfile.run-env changes)
    runs-on: ubuntu-latest
    outputs:
      image: ${{ steps.build-image.outputs.image }}
      tag: ${{ steps.build-image.outputs.tag }}
      built: ${{ steps.build-image.outputs.built }}
      pushable: ${{ steps.build-image.outputs.pushable }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build run-env image
        id: build-image
        uses: ./.github/actions/docker-image
        with:
          dockerfile: Dockerfile.run-env
          image-name: enzos-run
          token: ${{ secrets.GITHUB_TOKEN }}

  build-and-test:
    runs-on: ubuntu-latest
    needs:
      - build-build-env
      - build-run-env
    permissions:
      contents: write
      packages: read
      pull-requests: write
    env:
      BUILD_IMAGE: ${{ needs.build-build-env.outputs.image }}
      BUILD_IMAGE_TAG: ${{ needs.build-build-env.outputs.tag }}
      BUILD_IMAGE_BUILT: ${{ needs.build-build-env.outputs.built }}
      BUILD_IMAGE_PUSHABLE: ${{ needs.build-build-env.outputs.pushable }}
      RUN_IMAGE: ${{ needs.build-run-env.outputs.image }}
      RUN_IMAGE_TAG: ${{ needs.build-run-env.outputs.tag }}
      RUN_IMAGE_BUILT: ${{ needs.build-run-env.outputs.built }}
      RUN_IMAGE_PUSHABLE: ${{ needs.build-run-env.outputs.pushable }}
      QEMU_CONTAINER_NAME: enzos-qemu-${{ github.run_id }}-${{ github.run_attempt }}
      PR_SMOKE_IMAGE_NAME: qemu-screen-smoke-${{ github.run_id }}-${{ github.run_attempt }}.png
      PR_INTEGRATION_IMAGE_NAME: qemu-screen-integration-${{ github.run_id }}-${{ github.run_attempt }}.png
      PR_INTEGRATION_TERMINAL_IMAGE_NAME: qemu-screen-integration-terminal-${{ github.run_id }}-${{ github.run_attempt }}.png
      QEMU_MONITOR_ADDR: 127.0.0.1:45454
      QEMU_PIDFILE: /tmp/qemu-ci.pid
      VNC_PORT: 1
      VNC_CONNECT_ADDR: 127.0.0.1

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build
        uses: ./.github/actions/build
        with:
          build-image: ${{ env.BUILD_IMAGE }}
          build-tag: ${{ env.BUILD_IMAGE_TAG }}
          build-built: ${{ env.BUILD_IMAGE_BUILT }}
          build-pushable: ${{ env.BUILD_IMAGE_PUSHABLE }}
          run-image: ${{ env.RUN_IMAGE }}
          run-tag: ${{ env.RUN_IMAGE_TAG }}
          run-built: ${{ env.RUN_IMAGE_BUILT }}
          run-pushable: ${{ env.RUN_IMAGE_PUSHABLE }}

      - name: Start VM
        uses: ./.github/actions/start-vm
        with:
          container-name: ${{ env.QEMU_CONTAINER_NAME }}
          qemu-monitor-addr: ${{ env.QEMU_MONITOR_ADDR }}
          qemu-pidfile: ${{ env.QEMU_PIDFILE }}
          vnc-port: ${{ env.VNC_PORT }}

      - name: OS readiness test
        uses: ./.github/actions/smoke-test
        with:
          container-name: ${{ env.QEMU_CONTAINER_NAME }}
          qemu-monitor-addr: ${{ env.QEMU_MONITOR_ADDR }}
          vnc-port: ${{ env.VNC_PORT }}
          vnc-connect-addr: ${{ env.VNC_CONNECT_ADDR }}

      - name: Integration test
        uses: ./.github/actions/integration-test
        with:
          container-name: ${{ env.QEMU_CONTAINER_NAME }}
          qemu-pidfile: ${{ env.QEMU_PIDFILE }}
          qemu-monitor-addr: ${{ env.QEMU_MONITOR_ADDR }}
          vnc-port: ${{ env.VNC_PORT }}
          vnc-connect-addr: ${{ env.VNC_CONNECT_ADDR }}

      - name: Upload reports
        if: always()
        uses: ./.github/actions/upload-reports
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          smoke-image-name: ${{ env.PR_SMOKE_IMAGE_NAME }}
          integration-image-name: ${{ env.PR_INTEGRATION_IMAGE_NAME }}
          integration-terminal-image-name: ${{ env.PR_INTEGRATION_TERMINAL_IMAGE_NAME }}

      - name: Stop VM
        if: always()
        uses: ./.github/actions/stop-vm
        with:
          container-name: ${{ env.QEMU_CONTAINER_NAME }}
          qemu-monitor-addr: ${{ env.QEMU_MONITOR_ADDR }}
          qemu-pidfile: ${{ env.QEMU_PIDFILE }}
