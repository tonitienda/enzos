name: CI

on:
  pull_request:

permissions:
  contents: read
  packages: write

jobs:
  build-build-env:
    name: Build build-env image (only when Dockerfile.build-env changes)
    runs-on: ubuntu-latest
    outputs:
      image: ${{ steps.build-image.outputs.image }}
      tag: ${{ steps.build-image.outputs.tag }}
      built: ${{ steps.build-image.outputs.built }}
      pushable: ${{ steps.build-image.outputs.pushable }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build build-env image
        id: build-image
        uses: ./.github/actions/docker-image
        with:
          dockerfile: Dockerfile.build-env
          image-name: enzos-build
          build-args: --build-arg MAKE_JOBS=1
          token: ${{ secrets.GITHUB_TOKEN }}

  build-run-env:
    name: Build run-env image (only when Dockerfile.run-env changes)
    runs-on: ubuntu-latest
    outputs:
      image: ${{ steps.build-image.outputs.image }}
      tag: ${{ steps.build-image.outputs.tag }}
      built: ${{ steps.build-image.outputs.built }}
      pushable: ${{ steps.build-image.outputs.pushable }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build run-env image
        id: build-image
        uses: ./.github/actions/docker-image
        with:
          dockerfile: Dockerfile.run-env
          image-name: enzos-run
          token: ${{ secrets.GITHUB_TOKEN }}

  build-and-test:
    runs-on: ubuntu-latest
    needs:
      - build-build-env
      - build-run-env
    permissions:
      contents: write
      packages: read
      pull-requests: write
    env:
      BUILD_IMAGE: ${{ needs.build-build-env.outputs.image }}
      BUILD_IMAGE_TAG: ${{ needs.build-build-env.outputs.tag }}
      BUILD_IMAGE_BUILT: ${{ needs.build-build-env.outputs.built }}
      BUILD_IMAGE_PUSHABLE: ${{ needs.build-build-env.outputs.pushable }}
      RUN_IMAGE: ${{ needs.build-run-env.outputs.image }}
      RUN_IMAGE_TAG: ${{ needs.build-run-env.outputs.tag }}
      RUN_IMAGE_BUILT: ${{ needs.build-run-env.outputs.built }}
      RUN_IMAGE_PUSHABLE: ${{ needs.build-run-env.outputs.pushable }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build
        uses: ./.github/actions/build
        with:
          build-image: ${{ env.BUILD_IMAGE }}
          build-tag: ${{ env.BUILD_IMAGE_TAG }}
          build-built: ${{ env.BUILD_IMAGE_BUILT }}
          build-pushable: ${{ env.BUILD_IMAGE_PUSHABLE }}
          run-image: ${{ env.RUN_IMAGE }}
          run-tag: ${{ env.RUN_IMAGE_TAG }}
          run-built: ${{ env.RUN_IMAGE_BUILT }}
          run-pushable: ${{ env.RUN_IMAGE_PUSHABLE }}

      - name: Run integration tests
        run: |
          docker run --rm \
            -v "$PWD":/src \
            -w /src \
            enzos-run \
            /src/scripts/integration-test.sh --headless

      - name: Upload test screenshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-screenshots
          path: |
            qemu-screen-*.png
            qemu-screen-*.ppm
          if-no-files-found: warn

      - name: Upload VNC screenshots to repository
        if: always()
        id: upload_vnc_images
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: "const upload = require('./.github/scripts/upload-vnc-images.js'); await upload({ github, context, core });"

      - name: Prepare PR comment for screenshots
        if: always() && github.event_name == 'pull_request'
        id: prepare_vnc_comment
        shell: bash
        env:
          UPLOADED_IMAGES: ${{ steps.upload_vnc_images.outputs.images }}
        run: .github/scripts/prepare-vnc-comment.sh pr-vnc-comment.md

      - name: Comment PR with screenshots
        if: always() && github.event_name == 'pull_request' && steps.prepare_vnc_comment.outputs.has_content == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: "const commentWithFile = require('./.github/scripts/comment-with-file.js'); await commentWithFile({ github, context, core }, 'pr-vnc-comment.md');"
